<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Catálogo com Estoque e Lista</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f0f0f0; }
  h1 { text-align:center; }
  .produto { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; }
  label { margin-right:10px; }
  select, input[type="number"] { margin-left:5px; width:70px; }
  button { cursor:pointer; padding:8px 15px; background:#007bff; border:none; color:#fff; border-radius:4px; }
  button:hover { background:#0056b3; }
  #listaCompra { background:#fff; max-width:800px; margin:20px auto; padding:15px; border-radius:8px; display:none; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#007bff; color:#fff; }
  .btn-remover { background:#dc3545; border:none; color:#fff; padding:5px 10px; border-radius:4px; cursor:pointer; }
  .btn-remover:hover { background:#a71d2a; }
  select, input { width: 100%; box-sizing: border-box; }
</style>
</head>
<body>

<h1>Catálogo Online</h1>

<div id="catalogo">

  <div class="produto" data-codigo="CAM001" data-nome="Camiseta Básica" data-preco="50" data-estoque="10">
    <h2>Código: CAM001 - Camiseta Básica</h2>
    <p>Preço unitário: R$ 50,00</p>
    <p>Estoque disponível: <span class="estoque">10</span></p>
    <label>Cor:
      <select class="cor">
        <option value="">Selecione</option>
        <option>Preto</option>
        <option>Branco</option>
        <option>Azul</option>
      </select>
    </label>
    <label>Tamanho:
      <select class="tamanho">
        <option value="">Selecione</option>
        <option>P</option>
        <option>M</option>
        <option>G</option>
        <option>GG</option>
      </select>
    </label>
    <label>Quantidade:
      <input type="number" class="quantidade" value="1" min="1" />
    </label>
    <button class="btn-adicionar">Adicionar à lista</button>
  </div>

  <div class="produto" data-codigo="CAL002" data-nome="Calça Jeans" data-preco="120" data-estoque="5">
    <h2>Código: CAL002 - Calça Jeans</h2>
    <p>Preço unitário: R$ 120,00</p>
    <p>Estoque disponível: <span class="estoque">5</span></p>
    <label>Cor:
      <select class="cor">
        <option value="">Selecione</option>
        <option>Azul Claro</option>
        <option>Azul Escuro</option>
        <option>Preto</option>
      </select>
    </label>
    <label>Tamanho:
      <select class="tamanho">
        <option value="">Selecione</option>
        <option>36</option>
        <option>38</option>
        <option>40</option>
        <option>42</option>
      </select>
    </label>
    <label>Quantidade:
      <input type="number" class="quantidade" value="1" min="1" />
    </label>
    <button class="btn-adicionar">Adicionar à lista</button>
  </div>

</div>

<div id="listaCompra">
  <h3>Lista de Compra</h3>
  <table>
    <thead>
      <tr>
        <th>Código</th>
        <th>Produto</th>
        <th>Cor</th>
        <th>Tamanho</th>
        <th>Quantidade</th>
        <th>Preço Unit.</th>
        <th>Total</th>
        <th>Remover</th>
      </tr>
    </thead>
    <tbody id="lista-corpo">
      <!-- Itens da lista -->
    </tbody>
  </table>
</div>

<script>
  // Função para atualizar a quantidade de um item já na lista (soma com a nova)
  function atualizarQuantidadeExistente(tr, novaQtd, estoque){
    const inputQtd = tr.querySelector('.input-quantidade');
    const qtdAtual = parseInt(inputQtd.value);
    let somaQtd = qtdAtual + novaQtd;
    if (somaQtd > estoque) {
      alert('Quantidade máxima disponível no estoque: ' + estoque);
      somaQtd = estoque;
    }
    inputQtd.value = somaQtd;
    atualizarTotal(tr);
  }

  // Atualiza o total de uma linha
  function atualizarTotal(tr){
    const preco = parseFloat(tr.dataset.preco);
    const qtd = parseInt(tr.querySelector('.input-quantidade').value);
    const totalTd = tr.querySelector('.total');
    totalTd.textContent = 'R$ ' + (preco * qtd).toFixed(2);
  }

  // Verifica se a combinação já existe na lista (código + cor + tamanho)
  function itemExiste(codigo, cor, tamanho){
    const linhas = document.querySelectorAll('#lista-corpo tr');
    for(const tr of linhas){
      if(
        tr.dataset.codigo === codigo &&
        tr.querySelector('.select-cor').value === cor &&
        tr.querySelector('.select-tamanho').value === tamanho
      ){
        return tr;
      }
    }
    return null;
  }

  // Atualiza a exibição do estoque na página
  function atualizarEstoqueNaPagina(){
    const produtos = document.querySelectorAll('.produto');
    produtos.forEach(prod => {
      const estoque = parseInt(prod.dataset.estoque);
      prod.querySelector('.estoque').textContent = estoque;
    });
  }
  atualizarEstoqueNaPagina();

  // Evento dos botões "Adicionar à lista"
  document.querySelectorAll('.btn-adicionar').forEach(btn => {
    btn.addEventListener('click', () => {
      const produtoDiv = btn.closest('.produto');
      const codigo = produtoDiv.dataset.codigo;
      const nome = produtoDiv.dataset.nome;
      const preco = parseFloat(produtoDiv.dataset.preco);
      const estoque = parseInt(produtoDiv.dataset.estoque);

      const corSelect = produtoDiv.querySelector('.cor');
      const tamanhoSelect = produtoDiv.querySelector('.tamanho');
      const qtdInput = produtoDiv.querySelector('.quantidade');

      const cor = corSelect.value;
      const tamanho = tamanhoSelect.value;
      const quantidade = parseInt(qtdInput.value);

      if (!cor) {
        alert('Selecione a cor');
        return;
      }
      if (!tamanho) {
        alert('Selecione o tamanho');
        return;
      }
      if (!quantidade || quantidade < 1) {
        alert('Quantidade inválida');
        return;
      }

      // Verifica estoque (considerando quantidade já na lista)
      let trExistente = itemExiste(codigo, cor, tamanho);
      let qtdNaLista = 0;
      if(trExistente){
        qtdNaLista = parseInt(trExistente.querySelector('.input-quantidade').value);
      }
      if(quantidade + qtdNaLista > estoque){
        alert('Quantidade indisponível no estoque. Estoque disponível: ' + (estoque - qtdNaLista));
        return;
      }

      // Adicionar na lista
      if(trExistente){
        atualizarQuantidadeExistente(trExistente, quantidade, estoque);
      } else {
        adicionarLinhaLista(codigo, nome, cor, tamanho, quantidade, preco, estoque);
      }

      document.getElementById('listaCompra').style.display = 'block';

      // Resetar seleções para padrão
      corSelect.value = '';
      tamanhoSelect.value = '';
      qtdInput.value = 1;
    });
  });

  // Função para adicionar linha nova na tabela
  function adicionarLinhaLista(codigo, nome, cor, tamanho, quantidade, preco, estoque){
    const tbody = document.getElementById('lista-corpo');

    const tr = document.createElement('tr');
    tr.dataset.codigo = codigo;
    tr.dataset.preco = preco;

    // Código (fixo)
    const tdCodigo = document.createElement('td');
    tdCodigo.textContent = codigo;
    tr.appendChild(tdCodigo);

    // Nome (fixo)
    const tdNome = document.createElement('td');
    tdNome.textContent = nome;
    tr.appendChild(tdNome);

    // Cor (select editável)
    const tdCor = document.createElement('td');
    const selectCor = document.createElement('select');
    selectCor.classList.add('select-cor');
    // Opções baseadas no produto
    const opcoesCor = getOpcoes(codigo, 'cor');
    opcoesCor.forEach(corOp => {
      const option = document.createElement('option');
      option.value = corOp;
      option.textContent = corOp;
      if(corOp === cor) option.selected = true;
      selectCor.appendChild(option);
    });
    tdCor.appendChild(selectCor);
    tr.appendChild(tdCor);

    // Tamanho (select editável)
    const tdTam = document.createElement('td');
    const selectTam = document.createElement('select');
    selectTam.classList.add('select-tamanho');
    const opcoesTam = getOpcoes(codigo, 'tamanho');
    opcoesTam.forEach(tamOp => {
      const option = document.createElement('option');
      option.value = tamOp;
      option.textContent = tamOp;
      if(tamOp === tamanho) option.selected = true;
      selectTam.appendChild(option);
    });
    tdTam.appendChild(selectTam);
    tr.appendChild(tdTam);

    // Quantidade (input number editável)
    const tdQtd = document.createElement('td');
    const inputQtd = document.createElement('input');
    inputQtd.type = 'number';
    inputQtd.min = 1;
    inputQtd.value = quantidade;
    inputQtd.classList.add('input-quantidade');
    tdQtd.appendChild(inputQtd);
    tr.appendChild(tdQtd);

    // Preço unitário (fixo)
    const tdPreco = document.createElement('td');
    tdPreco.textContent = 'R$ ' + preco.toFixed(2);
    tr.appendChild(tdPreco);

    // Total (preço * quantidade)
    const tdTotal = document.createElement('td');
    tdTotal.classList.add('total');
    tdTotal.textContent = 'R$ ' + (preco * quantidade).toFixed(2);
    tr.appendChild(tdTotal);

    // Botão remover
    const tdRemover = document.createElement('td');
    const btnRemover = document.createElement('button');
    btnRemover.classList.add('btn-remover');
    btnRemover.textContent = 'X';
    btnRemover.addEventListener('click', () => {
      tr.remove();
      if(document.getElementById('lista-corpo').children.length === 0){
        document.getElementById('listaCompra').style.display = 'none';
      }
    });
    tdRemover.appendChild(btnRemover);
    tr.appendChild(tdRemover);

    // Eventos para validar quantidade máximo e atualizar total
    function validarQtd(){
      let qtd = parseInt(inputQtd.value);
      if(isNaN(qtd) || qtd < 1) qtd = 1;

      // Validar estoque total para essa combinação
      const estoqueTotal = getEstoque(codigo);
      let somaOutros = 0;
      const linhas = document.querySelectorAll('#lista-corpo tr');
      linhas.forEach(linha => {
        if(linha !== tr){
          const c = linha.dataset.codigo;
          const corLinha = linha.querySelector('.select-cor').value;
          const tamLinha = linha.querySelector('.select-tamanho').value;
          if(c === codigo && corLinha === selectCor.value && tamLinha === selectTam.value){
            somaOutros += parseInt(linha.querySelector('.input-quantidade').value);
          }
        }
      });
      if(qtd + somaOutros > estoqueTotal){
        alert('Quantidade máxima disponível no estoque para essa combinação: ' + (estoqueTotal - somaOutros));
        qtd = estoqueTotal - somaOutros;
        if(qtd < 1) qtd = 1;
      }
      inputQtd.value = qtd;
      atualizarTotal(tr);
    }

    inputQtd.addEventListener('input', validarQtd);

    // Atualiza quantidade ao mudar cor ou tamanho para evitar duplicidade e validar estoque
    function validarCombo(){
      // Se já existir outra linha com essa combinação, avisa
      const linhas = document.querySelectorAll('#lista-corpo tr');
      linhas.forEach(linha => {
        if(linha !== tr){
          if(
            linha.dataset.codigo === codigo &&
            linha.querySelector('.select-cor').value === selectCor.value &&
            linha.querySelector('.select-tamanho').value === selectTam.value
          ){
            alert('Já existe essa combinação na lista. Edite a quantidade nesse item.');
            // Reseta para a anterior
            selectCor.value = cor;
            selectTam.value = tamanho;
          }
        }
      });
      validarQtd();
    }

    selectCor.addEventListener('change', validarCombo);
    selectTam.addEventListener('change', validarCombo);

    tbody.appendChild(tr);
  }

  // Função para retornar as opções de cor ou tamanho baseado no código do produto
  function getOpcoes(codigo, tipo){
    const produtoDiv = [...document.querySelectorAll('.produto')].find(p => p.dataset.codigo === codigo);
    if(!produtoDiv) return [];
    if(tipo === 'cor') {
      return Array.from(produtoDiv.querySelector('.cor').options).map(opt => opt.value).filter(v => v);
    }
    if(tipo === 'tamanho') {
      return Array.from(produtoDiv.querySelector('.tamanho').options).map(opt => opt.value).filter(v => v);
    }
    return [];
  }

  // Função para pegar o estoque disponível do produto
  function getEstoque(codigo){
    const produtoDiv = [...document.querySelectorAll('.produto')].find(p => p.dataset.codigo === codigo);
    if(!produtoDiv) return 0;
    return parseInt(produtoDiv.dataset.estoque);
  }
</script>

</body>
</html>
